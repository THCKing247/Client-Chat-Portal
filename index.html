<!doctype html>
<html lang="en">
<head>
  <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-4961344406816399"
     crossorigin="anonymous"></script>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>AI Chatbot Portal | Client Portal | Apex Technical Solutions Group LLC</title>
  <meta name="description" content="Access your AI Chatbot portal and manage your chatbot configuration." />
  <link rel="canonical" href="https://apextsgroup.com/chatbot/portal/" />
  <meta property="og:type" content="website" />
  <meta property="og:url" content="https://apextsgroup.com/chatbot/portal/" />
  <meta property="og:title" content="AI Chatbot Portal | Client Portal | Apex Technical Solutions Group LLC" />
  <meta property="og:description" content="Access your AI Chatbot portal and manage your chatbot configuration." />
  <meta property="og:image" content="https://apextsgroup.com/assets/logo.png" />
  <meta property="twitter:card" content="summary" />
  <meta property="twitter:title" content="AI Chatbot Portal | Client Portal | Apex Technical Solutions Group LLC" />
  <meta property="twitter:description" content="Access your AI Chatbot portal and manage your chatbot configuration." />
  <link rel="icon" type="image/png" href="/assets/logo.png" />
  <link rel="stylesheet" href="/assets/site.css">
  <style>
    .chatbot-portal-container {
      width: 100%;
      height: calc(100vh - 200px);
      min-height: 600px;
      border: 1px solid var(--border);
      border-radius: var(--radius);
      overflow: hidden;
      background: var(--card);
    }
    .chatbot-portal-iframe {
      width: 100%;
      height: 100%;
      border: none;
      display: block;
    }
    .chatbot-portal-loading {
      display: flex;
      align-items: center;
      justify-content: center;
      height: 100%;
      flex-direction: column;
      gap: 16px;
    }
    .chatbot-portal-error {
      padding: 24px;
      text-align: center;
      color: var(--muted);
    }
    .chatbot-portal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 24px;
      flex-wrap: wrap;
      gap: 16px;
    }
  </style>
</head>

<body>
  <a href="#main-content" class="skip-link">Skip to main content</a>
  <div class="bg-animated" aria-hidden="true">
    <span class="blob b1"></span><span class="blob b2"></span><span class="blob b3"></span>
    <canvas id="particles"></canvas>
  </div>

  <div class="wrap">
    <header class="site-header reveal">
      <a class="brand-link" href="/">
        <img class="brand-logo" src="/assets/logo.png" alt="Apex Technical Solutions Group LLC logo" loading="lazy">
        <span class="brand-name">Apex Technical Solutions Group LLC</span>
      </a>
      <nav class="nav" id="mainNav">
        <a href="/">Home</a>
        <a href="/services/">Services</a>
        <a href="/about/">About</a>
        <a href="/resources/">Resources</a>
        <a href="/contact/">Contact</a>
        <a href="/dashboard/">Dashboard</a>
      </nav>
      <button class="mobile-menu-toggle" aria-label="Toggle menu" aria-expanded="false" aria-controls="mainNav">â˜°</button>
    </header>

    <main id="main-content">
      <nav class="breadcrumbs reveal" aria-label="Breadcrumb">
        <ul style="list-style:none;padding:0;margin:0;display:flex;flex-wrap:wrap;gap:8px;">
          <li><a href="/">Home</a></li>
          <li><a href="/dashboard/">Dashboard</a></li>
          <li><a href="/chatbot/login/">AI Chatbot Login</a></li>
          <li class="current">Chatbot Portal</li>
        </ul>
      </nav>

      <section class="reveal">
        <div class="chatbot-portal-header">
          <div>
            <h1 style="margin:0 0 8px;font-size:38px;letter-spacing:-.6px;">AI Chatbot Portal</h1>
            <p style="margin:0;color:var(--muted);font-size:16px;">Manage your chatbot configuration and conversations.</p>
          </div>
          <div style="display:flex;gap:12px;">
            <a href="/dashboard/" class="btn">Back to Dashboard</a>
            <button class="btn" onclick="logoutChatbot()" style="white-space:nowrap;">Sign Out</button>
          </div>
        </div>
      </section>

      <section class="reveal" style="margin:32px 0;">
        <div class="chatbot-portal-container" id="portal-container">
          <div class="chatbot-portal-loading" id="portal-loading">
            <div style="font-size:48px;">ðŸ¤–</div>
            <p style="color:var(--muted);">Loading chatbot portal...</p>
          </div>
          <div class="chatbot-portal-error" id="portal-error" style="display:none;"></div>
          <iframe 
            id="chatbot-iframe" 
            class="chatbot-portal-iframe" 
            style="display:none;"
            title="AI Chatbot Portal"
            allow="clipboard-read; clipboard-write"
          ></iframe>
        </div>
      </section>
    </main>
  </div>

  <!-- Load Supabase client -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>
  <script src="/assets/site.js" defer></script>
  <script>
    // Chatbot Portal Configuration
    const CHATBOT_CONFIG = {
      supabaseUrl: window.CHATBOT_SUPABASE_URL || 'https://your-project.supabase.co',
      supabaseAnonKey: window.CHATBOT_SUPABASE_ANON_KEY || 'your-anon-key',
      // Set this to your deployed chatbot portal URL (e.g., Vercel, Netlify, or GitHub Pages)
      portalUrl: window.CHATBOT_PORTAL_URL || 'https://chatbot.apextsgroup.com'
    };

    let supabaseClient = null;
    let portalIframe = null;

    // Initialize Supabase client
    function initSupabase() {
      if (!CHATBOT_CONFIG.supabaseUrl || !CHATBOT_CONFIG.supabaseAnonKey) {
        showError('Configuration error: Supabase credentials not set.');
        return false;
      }

      if (typeof supabase === 'undefined') {
        showError('Authentication library failed to load. Please refresh the page.');
        return false;
      }

      try {
        supabaseClient = supabase.createClient(CHATBOT_CONFIG.supabaseUrl, CHATBOT_CONFIG.supabaseAnonKey);
        return true;
      } catch (error) {
        console.error('Failed to initialize Supabase:', error);
        showError('Failed to initialize authentication system.');
        return false;
      }
    }

    // Load chatbot portal
    async function loadChatbotPortal() {
      const loadingDiv = document.getElementById('portal-loading');
      const errorDiv = document.getElementById('portal-error');
      const iframe = document.getElementById('chatbot-iframe');

      if (!supabaseClient) {
        showError('Authentication not initialized.');
        return;
      }

      try {
        // Check for session
        const { data: { session }, error } = await supabaseClient.auth.getSession();
        
        if (error || !session) {
          // No session, redirect to login
          window.location.href = '/chatbot/login/';
          return;
        }

        // Get access token
        const accessToken = session.access_token;
        
        // Build portal URL with token parameter
        // Note: We'll pass the token via postMessage for security
        const portalUrl = CHATBOT_CONFIG.portalUrl;
        
        // Validate portal URL
        if (!portalUrl || portalUrl.includes('localhost') || portalUrl.includes('127.0.0.1')) {
          console.warn('Portal URL appears to be localhost. For production, use a deployed URL.');
          showError('The chatbot portal URL is configured for localhost. Please configure <code>CHATBOT_PORTAL_URL</code> to point to your deployed portal (e.g., https://chatbot.apextsgroup.com)');
          return;
        }
        
        console.log('Loading chatbot portal from:', portalUrl);
        
        // Set iframe source
        console.log('Loading chatbot portal from:', portalUrl);
        iframe.src = portalUrl;
        iframe.style.display = 'block';
        // Keep loading visible until iframe actually loads

        // Wait for iframe to load, then send session token
        iframe.onload = function() {
          try {
            // Send session data to iframe via postMessage
            // The portal will need to handle this message and initialize Supabase with the token
            iframe.contentWindow.postMessage({
              type: 'SUPABASE_SESSION',
              session: {
                access_token: accessToken,
                refresh_token: session.refresh_token,
                expires_at: session.expires_at,
                expires_in: session.expires_in,
                token_type: session.token_type,
                user: session.user
              },
              supabaseUrl: CHATBOT_CONFIG.supabaseUrl,
              supabaseAnonKey: CHATBOT_CONFIG.supabaseAnonKey
            }, portalUrl);
          } catch (e) {
            console.error('Error sending session to iframe:', e);
            // If same-origin policy blocks, the portal will need to use its own Supabase client
            // which should share the same session via cookies/localStorage if same domain
          }
        };

        // Handle errors - iframe onerror doesn't always fire, so we'll use a timeout
        let loadTimeout = setTimeout(() => {
          // If iframe hasn't loaded after 10 seconds, show error
          if (iframe.style.display === 'block' && !iframe.contentWindow) {
            loadingDiv.style.display = 'none';
            showError('Failed to load chatbot portal from ' + portalUrl + 
              '<br><br><strong>Possible causes:</strong><br>' +
              '1. The portal is not deployed or not accessible at this URL<br>' +
              '2. CORS or network connectivity issues<br>' +
              '3. The portal URL is incorrect<br><br>' +
              'Please verify that <code>CHATBOT_PORTAL_URL</code> points to your deployed portal.');
          }
        }, 10000);

        iframe.onload = function() {
          clearTimeout(loadTimeout);
          // Check if iframe loaded successfully by trying to access contentWindow
          try {
            // If we can access contentWindow, it loaded (but may have errors)
            // The portal itself will handle displaying errors
          } catch (e) {
            // Cross-origin or other error
            console.warn('Iframe loaded but may have cross-origin restrictions:', e);
          }
        };

        // Also handle network errors
        iframe.onerror = function() {
          clearTimeout(loadTimeout);
          loadingDiv.style.display = 'none';
          showError('Failed to load chatbot portal from ' + portalUrl + 
            '<br><br><strong>Common causes:</strong><br>' +
            '1. Portal is not deployed or not accessible at this URL<br>' +
            '2. Wrong URL configured in <code>CHATBOT_PORTAL_URL</code><br>' +
            '3. CORS or network connectivity issues<br>' +
            '4. Portal deployment may have failed or be down');
        };

      } catch (error) {
        console.error('Error loading portal:', error);
        loadingDiv.style.display = 'none';
        showError('An error occurred while loading the portal: ' + error.message);
      }
    }

    // Logout from chatbot
    async function logoutChatbot() {
      if (supabaseClient) {
        await supabaseClient.auth.signOut();
      }
      window.location.href = '/chatbot/login/';
    }

    // Show error message
    function showError(message) {
      const loadingDiv = document.getElementById('portal-loading');
      const errorDiv = document.getElementById('portal-error');
      loadingDiv.style.display = 'none';
      errorDiv.style.display = 'block';
      errorDiv.innerHTML = message;
      errorDiv.style.padding = '24px';
      errorDiv.style.textAlign = 'center';
      errorDiv.style.color = 'var(--muted)';
      errorDiv.style.lineHeight = '1.6';
    }

    // Initialize on page load
    document.addEventListener('DOMContentLoaded', async () => {
      if (initSupabase()) {
        await loadChatbotPortal();
      }
    });
  </script>
</body>
</html>

