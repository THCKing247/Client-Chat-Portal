<!doctype html>
<html lang="en">
<head>
  <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-4961344406816399"
     crossorigin="anonymous"></script>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Reports | Client Portal | Apex Technical Solutions Group LLC</title>
  <meta name="description" content="View detailed reports on your chat conversations, messages, and usage statistics." />
  <link rel="canonical" href="https://apextsgroup.com/reports/" />
  <meta property="og:type" content="website" />
  <meta property="og:url" content="https://apextsgroup.com/reports/" />
  <meta property="og:title" content="Reports | Client Portal | Apex Technical Solutions Group LLC" />
  <meta property="og:description" content="View detailed reports on your chat conversations and usage statistics." />
  <meta property="og:image" content="https://apextsgroup.com/assets/logo.png" />
  <meta property="twitter:card" content="summary" />
  <meta property="twitter:title" content="Reports | Client Portal | Apex Technical Solutions Group LLC" />
  <meta property="twitter:description" content="View detailed reports on your chat conversations and usage statistics." />
  <link rel="icon" type="image/png" href="/assets/logo.png" />
  <link rel="stylesheet" href="/assets/site.css">
</head>

<body>
  <a href="#main-content" class="skip-link">Skip to main content</a>
  <div class="bg-animated" aria-hidden="true">
    <span class="blob b1"></span><span class="blob b2"></span><span class="blob b3"></span>
    <canvas id="particles"></canvas>
  </div>

  <div class="wrap">
    <header class="site-header reveal">
      <a class="brand-link" href="/">
        <img class="brand-logo" src="/assets/logo.png" alt="Apex Technical Solutions Group LLC logo" loading="lazy">
        <span class="brand-name">Apex Technical Solutions Group LLC</span>
      </a>
      <nav class="nav" id="mainNav">
        <a href="/">Home</a>
        <a href="/services/">Services</a>
        <a href="/about/">About</a>
        <a href="/resources/">Resources</a>
        <a href="/contact/">Contact</a>
        <a href="/dashboard/" class="active">Dashboard</a>
      </nav>
      <button class="mobile-menu-toggle" aria-label="Toggle menu" aria-expanded="false" aria-controls="mainNav">‚ò∞</button>
    </header>

    <main id="main-content">
      <nav class="breadcrumbs reveal" aria-label="Breadcrumb">
        <ul style="list-style:none;padding:0;margin:0;display:flex;flex-wrap:wrap;gap:8px;">
          <li><a href="/">Home</a></li>
          <li><a href="/dashboard/">Dashboard</a></li>
          <li class="current">Reports</li>
        </ul>
      </nav>

      <section class="reveal">
        <div class="dashboard-header">
          <div>
            <h1 style="margin:0 0 8px;font-size:38px;letter-spacing:-.6px;">Chat Reports & Analytics</h1>
            <p style="margin:0;color:var(--muted);font-size:16px;">Detailed insights into your chat conversations and message statistics.</p>
          </div>
          <div style="display:flex;gap:12px;">
            <a href="/dashboard/" class="btn">Back to Dashboard</a>
            <button class="btn primary" onclick="logout()" style="white-space:nowrap;">Sign Out</button>
          </div>
        </div>
      </section>

      <!-- Metrics Cards -->
      <section class="reveal" style="margin:32px 0;">
        <div class="reports-metrics-grid">
          <!-- Total Conversations - Last 7 Days -->
          <div class="metric-card">
            <div class="metric-icon">üí¨</div>
            <div class="metric-content">
              <div class="metric-label">Conversations (7 days)</div>
              <div class="metric-value" id="conversations-7d">-</div>
            </div>
          </div>

          <!-- Total Conversations - Last 30 Days -->
          <div class="metric-card">
            <div class="metric-icon">üìä</div>
            <div class="metric-content">
              <div class="metric-label">Conversations (30 days)</div>
              <div class="metric-value" id="conversations-30d">-</div>
            </div>
          </div>

          <!-- Total Messages -->
          <div class="metric-card">
            <div class="metric-icon">üì®</div>
            <div class="metric-content">
              <div class="metric-label">Total Messages</div>
              <div class="metric-value" id="total-messages">-</div>
            </div>
          </div>

          <!-- Average Messages per Conversation -->
          <div class="metric-card">
            <div class="metric-icon">üìà</div>
            <div class="metric-content">
              <div class="metric-label">Avg Messages/Conversation</div>
              <div class="metric-value" id="avg-messages">-</div>
            </div>
          </div>
        </div>
      </section>

      <!-- Most Recent Conversations -->
      <section class="reveal" style="margin:48px 0;">
        <div class="section-head">
          <h2>Most Recent Conversations</h2>
          <p>Your latest chat sessions and interactions.</p>
        </div>

        <div id="recent-conversations-container">
          <!-- Conversations will be populated by JavaScript -->
          <div style="text-align:center;padding:48px;color:var(--muted);">
            <p>Loading conversations...</p>
          </div>
        </div>
      </section>

      <!-- Future: Cost/Tokens Section (Placeholder) -->
      <section class="reveal" style="margin:48px 0;padding:32px;background:rgba(0,0,0,.2);border:1px solid var(--border);border-radius:var(--radius);">
        <div class="section-head">
          <h2>Cost & Token Usage</h2>
          <p style="color:var(--muted);font-size:14px;">Coming soon: Detailed cost breakdown and token usage analytics.</p>
        </div>
      </section>
    </main>
  </div>

  <script src="/assets/site.js" defer></script>
  <script>
    // Initialize reports page
    document.addEventListener('DOMContentLoaded', () => {
      // Check authentication
      if (typeof Auth === 'undefined' || !Auth.isValidSession()) {
        window.location.href = '/login/';
        return;
      }

      initReports();
    });

    function initReports() {
      const session = Auth.getSession();
      if (!session) {
        window.location.href = '/login/';
        return;
      }

      const clientData = Auth.getClientData(session.clientId);
      if (!clientData) {
        console.error('Client data not found');
        return;
      }

      // Calculate and display metrics
      calculateMetrics(clientData);
      
      // Render recent conversations
      renderRecentConversations(clientData);
    }

    function calculateMetrics(clientData) {
      const sessions = clientData.chatSessions || [];
      const now = new Date();
      
      // Last 7 days
      const sevenDaysAgo = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000);
      const conversations7d = sessions.filter(s => {
        const startTime = new Date(s.startTime);
        return startTime >= sevenDaysAgo;
      });

      // Last 30 days
      const thirtyDaysAgo = new Date(now.getTime() - 30 * 24 * 60 * 60 * 1000);
      const conversations30d = sessions.filter(s => {
        const startTime = new Date(s.startTime);
        return startTime >= thirtyDaysAgo;
      });

      // Total messages across all sessions
      const totalMessages = sessions.reduce((sum, session) => {
        return sum + (session.messageCount || (session.messages ? session.messages.length : 0));
      }, 0);

      // Average messages per conversation
      const avgMessages = sessions.length > 0 
        ? (totalMessages / sessions.length).toFixed(1)
        : 0;

      // Update UI
      document.getElementById('conversations-7d').textContent = conversations7d.length;
      document.getElementById('conversations-30d').textContent = conversations30d.length;
      document.getElementById('total-messages').textContent = totalMessages.toLocaleString();
      document.getElementById('avg-messages').textContent = avgMessages;
    }

    function renderRecentConversations(clientData) {
      const container = document.getElementById('recent-conversations-container');
      if (!container) return;

      const sessions = (clientData.chatSessions || [])
        .sort((a, b) => {
          return new Date(b.startTime) - new Date(a.startTime);
        })
        .slice(0, 10); // Show most recent 10

      if (sessions.length === 0) {
        container.innerHTML = `
          <div style="text-align:center;padding:48px;color:var(--muted);">
            <p>No conversations found.</p>
          </div>
        `;
        return;
      }

      container.innerHTML = sessions.map(session => {
        const startDate = new Date(session.startTime);
        const endDate = session.endTime ? new Date(session.endTime) : null;
        const duration = endDate 
          ? Math.round((endDate - startDate) / 1000 / 60) 
          : 'Ongoing';
        
        const statusBadge = session.status === 'active' 
          ? '<span class="status-badge active">Active</span>'
          : '<span class="status-badge completed">Completed</span>';

        const ratingStars = session.rating 
          ? '‚≠ê'.repeat(session.rating) + ' (' + session.rating + '/5)'
          : 'No rating';

        const preview = session.messages && session.messages.length > 0
          ? session.messages[0].content.substring(0, 100) + (session.messages[0].content.length > 100 ? '...' : '')
          : 'No messages';

        return `
          <div class="conversation-card">
            <div class="conversation-header">
              <div>
                <h3 style="margin:0 0 4px;font-size:18px;">${session.visitorName || 'Anonymous Visitor'}</h3>
                <p style="margin:0;color:var(--muted);font-size:14px;">
                  ${session.visitorEmail || 'No email provided'} ‚Ä¢ ${startDate.toLocaleString('en-US', { 
                    month: 'short', 
                    day: 'numeric', 
                    year: 'numeric',
                    hour: 'numeric', 
                    minute: '2-digit' 
                  })}
                </p>
              </div>
              ${statusBadge}
            </div>
            <div class="conversation-stats">
              <span>üí¨ ${session.messageCount || (session.messages ? session.messages.length : 0)} messages</span>
              <span>‚è±Ô∏è ${duration} min</span>
              <span>${ratingStars}</span>
            </div>
            <div class="conversation-preview">
              <p style="margin:0;color:var(--muted);font-size:13px;font-style:italic;">
                "${preview}"
              </p>
            </div>
            <div class="conversation-actions">
              <button class="btn" onclick="viewConversation('${session.id}')">View Details</button>
            </div>
          </div>
        `;
      }).join('');
    }

    function viewConversation(sessionId) {
      // Navigate to conversation detail view (could be a modal or separate page)
      alert('Conversation detail view coming soon. Session ID: ' + sessionId);
    }
  </script>
</body>
</html>

